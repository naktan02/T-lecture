name: Calculate Distance Batch

on:
  schedule:
    # Îß§Ïùº KST 01:00 (UTC 16:00) - Í±∞Î¶¨ Î∞∞Ïπò Í≥ÑÏÇ∞
    - cron: '0 16 * * *'
  workflow_dispatch:

env:
  SERVER_URL: ${{ secrets.SERVER_URL }}
  BATCH_API_SECRET: ${{ secrets.BATCH_API_SECRET }}

jobs:
  calculate:
    name: Calculate Distance
    runs-on: ubuntu-latest
    steps:
      - name: Wake up server (Cold Start Î∞©ÏßÄ)
        shell: bash
        run: |
          echo "üîÑ Waking up server..."
          # ÏÑúÎ≤ÑÍ∞Ä Sleep ÏÉÅÌÉúÏùº Ïàò ÏûàÏúºÎØÄÎ°ú Î®ºÏ†Ä Íπ®ÏõÄ
          curl -sS --max-time 120 "$SERVER_URL/api/health" || echo "‚ö†Ô∏è Health check failed, but continuing..."
          echo "‚è≥ Waiting for server to fully wake up..."
          sleep 15

      - name: Trigger distance calculation
        shell: bash
        run: |
          set -euo pipefail
          echo "Starting distance batch calculation..."

          # body + http_code Í∞ôÏù¥ Î∞õÍ∏∞
          tmp="$(mktemp)"
          http_code=$(curl -sS --max-time 180 -o "$tmp" -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $BATCH_API_SECRET" \
            -H "Content-Type: application/json" \
            "$SERVER_URL/api/v1/batch/distance?limit=200" || echo "000")

          body="$(cat "$tmp")"
          echo "HTTP: $http_code"
          echo "Body: $body"

          if [[ "$http_code" != "200" ]]; then
            echo "‚ùå Batch request failed (HTTP $http_code)"
            exit 1
          fi

          # JSON ÌååÏã± ÏïàÏ†ÑÌïòÍ≤å
          if echo "$body" | jq -e . >/dev/null 2>&1; then
            success=$(echo "$body" | jq -r '.success // false')
            if [ "$success" = "true" ]; then
              processed=$(echo "$body" | jq -r '.processed // 0')
              needsRecalc=$(echo "$body" | jq -r '.needsRecalcCount // 0')
              echo "‚úÖ Batch completed: $processed processed, $needsRecalc pending"
            else
              echo "‚ùå Batch failed (success=false)"
              exit 1
            fi
          else
            echo "‚ùå Response is not valid JSON"
            exit 1
          fi
