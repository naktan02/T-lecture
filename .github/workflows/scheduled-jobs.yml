name: Scheduled Jobs

on:
  schedule:
    # 17분마다 - Render 서버 깨우기 (무료 티어 슬립 방지)
    - cron: '*/17 * * * *'
    # 매일 KST 03:00 (UTC 18:00) - 거리 배치 계산
    - cron: '0 18 * * *'
    # 5일마다 KST 03:00 (UTC 18:00) - Supabase 깨우기
    - cron: '0 18 */5 * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job type to run'
        required: true
        default: 'ping'
        type: choice
        options:
          - ping
          - distance
          - supabase

env:
  SERVER_URL: ${{ secrets.SERVER_URL }}
  BATCH_API_SECRET: ${{ secrets.BATCH_API_SECRET }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}

jobs:
  ping-server:
    name: Ping Render Server
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/17 * * * *' || github.event.inputs.job_type == 'ping'
    steps:
      - name: Ping server to keep awake
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SERVER_URL/api/v1/batch/ping")
          echo "Response: $response"
          if [ "$response" != "200" ]; then
            echo "Warning: Server responded with $response"
          fi

  calculate-distance:
    name: Calculate Distance Batch
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 18 * * *' || github.event.inputs.job_type == 'distance'
    steps:
      - name: Trigger distance calculation
        run: |
          echo "Starting distance batch calculation..."
          response=$(curl -s -X POST \
            -H "Authorization: Bearer $BATCH_API_SECRET" \
            -H "Content-Type: application/json" \
            "$SERVER_URL/api/v1/batch/distance?limit=200")
          echo "Response: $response"

          # Check if successful
          success=$(echo $response | jq -r '.success // false')
          if [ "$success" == "true" ]; then
            processed=$(echo $response | jq -r '.processed')
            needsRecalc=$(echo $response | jq -r '.needsRecalcCount')
            echo "✅ Batch completed: $processed processed, $needsRecalc pending"
          else
            echo "❌ Batch failed"
            exit 1
          fi

  ping-supabase:
    name: Ping Supabase
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 18 */5 * *' || github.event.inputs.job_type == 'supabase'
    steps:
      - name: Ping Supabase to keep awake
        run: |
          echo "Pinging Supabase..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SUPABASE_URL/rest/v1/")
          echo "Supabase response: $response"
